<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.canvus.app.dao.mapper.FeedsMapper">

<insert id="createFeedTableRow" parameterType="feed">
	INSERT INTO FEEDS(
	    FEED_ID
	    ,USER_ID1
	    ,USER_ID2
	    ,USER_ID3
	    ,USER_ID4
	    ,CONTEXT
	) VALUES (
	    #{feed_id}
	    ,#{user_id1}
	    ,#{user_id2, jdbcType=VARCHAR}
	    ,#{user_id3, jdbcType=VARCHAR}
	    ,#{user_id4, jdbcType=VARCHAR}
	    ,#{context}
	)
</insert>

<select id="selectFeed" parameterType="string" resultType="feed">
	SELECT
		FEED_ID
	    ,USER_ID1
	    ,USER_ID2
	    ,USER_ID3
	    ,USER_ID4
	    ,CONTEXT
		,TO_CHAR(INPUTDATE, 'yyyy-MM-dd')	AS	INPUTDATE
	FROM
		FEEDS
	WHERE
		FEED_ID = #{string}
</select>

<update id="updateFeed" parameterType="feed">
	UPDATE FEEDS SET
		CONTEXT = #{context}
	WHERE
		FEED_ID = #{feed_id}
</update>

<!-- FeedDAO / getFeedTotalCount / 특정 유저의 피드 갯수 산출 -->
<select id="getFeedTotalCount" parameterType="string" resultType="int">
	SELECT
		COUNT(*)
	FROM
		FEEDS
	WHERE
		USER_ID1 = #{string}
</select>

<select id="selectFeedBundle" parameterType="string" resultType="feedComponent">
	SELECT
		FEED_ID
		,USER_ID1
		,USER_ID2
		,USER_ID3
		,USER_ID4
		,CONTEXT
		,INPUTDATE
	FROM
		FEEDS
	WHERE
		USER_ID1 = #{string}
	ORDER BY
		INPUTDATE ASC
</select>

<select id="getFeedsBundleByIdList" parameterType="java.util.List" resultType="feedComponent">
	SELECT
		FEED_ID
		 ,USER_ID1
		 ,USER_ID2
		 ,USER_ID3
		 ,USER_ID4
		 ,CONTEXT
		 ,INPUTDATE
	FROM
		FEEDS
	WHERE
		FEED_ID IN (
			<foreach collection="list" item="one" separator=",">
				#{one.feed_id}
			</foreach>
		)
</select>

<select id="readFeedAbstract" parameterType="string" resultType="feed">
	SELECT
		FEED_ID
		,USER_ID1
		,USER_ID2
		,USER_ID3
		,USER_ID4
		,CONTEXT
		,TO_CHAR(INPUTDATE, 'yyyy-MM-dd') as inputdate
	FROM
		FEEDS
	WHERE
		FEED_ID = #{string}
</select>

	<!-- 성능 고려해서 오라클 함수를 만들어서 구성 -->
	<select id="homePreview" resultType="feedComponent">
		SELECT
			feed_id
			,preview
			,inputdate
		FROM
		(
			SELECT
				FD.FEED_ID  AS  feed_id
				,FD.PAGE_FILE   AS  preview
				,F.INPUTDATE AS  inputdate
			FROM
				FEED_DRAWINGS FD, FEEDS F
			WHERE
				FUNC_SPLIT(FD.PAGE_FILE, '--divide--', 1) = '1.png'
			AND
				F.FEED_ID = FD.FEED_ID
			ORDER BY
				inputdate DESC
		)
		WHERE
			ROWNUM &lt;= 5 <!-- &lt; 는 <를 의미한다 -->
	</select>
</mapper>